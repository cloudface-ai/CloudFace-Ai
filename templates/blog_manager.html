<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudFace AI Blog Manager</title>
    <link rel="stylesheet" href="/static/mobile-first.css">
    <style>
        :root {
            --primary: #1a73e8;
            --primary-dark: #0d47a1;
            --bg: #fafafa;
            --surface: #ffffff;
            --text: #202124;
            --muted: #5f6368;
            --border: #dadce0;
            --radius: 12px;
        }
        body {
            margin: 0;
            font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .header h1 {
            font-size: 22px;
            font-weight: 600;
            margin: 0;
        }
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
        }
        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
            min-width: 220px;
        }
        label {
            font-size: 12px;
            color: var(--muted);
        }
        input, select, textarea {
            font: inherit;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: #fff;
        }
        .editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        .inline-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .inline-row input {
            flex: 1;
        }
        .editor-area {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            min-height: 260px;
            background: #fff;
        }
        .editor-area:focus {
            outline: none;
            border-color: var(--primary);
        }
        .editor-area.drag-over {
            border-color: var(--primary);
            background: #f1f6ff;
        }
        .image-wrapper {
            display: inline-block;
            position: relative;
            max-width: 100%;
        }
        .image-wrapper img {
            display: block;
            max-width: 100%;
            height: auto;
        }
        .image-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--primary);
            border: 2px solid #fff;
            border-radius: 50%;
            right: -6px;
            bottom: -6px;
            cursor: se-resize;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .btn {
            padding: 10px 14px;
            border: 0;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn-primary {
            background: var(--primary);
            color: #fff;
        }
        .btn-secondary {
            background: #e8f0fe;
            color: var(--primary);
        }
        .btn-danger {
            background: #ea4335;
            color: #fff;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .post-list {
            display: grid;
            gap: 12px;
        }
        .post-item {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        .post-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .post-meta small {
            color: var(--muted);
        }
        .hidden {
            display: none;
        }
        .alert {
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 14px;
        }
        .alert-success {
            background: #e6f4ea;
            color: #137333;
        }
        .alert-error {
            background: #fce8e6;
            color: #b3261e;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Blog Manager</h1>
            <div class="row">
                <button class="btn btn-secondary" onclick="showList()">Posts</button>
                <button class="btn btn-primary" onclick="newPost()">New Post</button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div id="passwordCard" class="card">
            <div class="row">
                <div class="field" style="min-width: 280px;">
                    <label>Manager Password</label>
                    <input type="password" id="passwordInput" placeholder="Enter password">
                </div>
                <div class="field" style="min-width: 140px; align-self: flex-end;">
                    <button class="btn btn-primary" onclick="setPassword()">Unlock</button>
                </div>
            </div>
            <small style="color: var(--muted);">
                If your password contains a #, it will be URL-encoded automatically.
            </small>
        </div>

        <div id="listView" class="card hidden">
            <div class="row" style="justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">All Posts</h3>
                <button class="btn btn-secondary" onclick="loadPosts()">Refresh</button>
            </div>
            <div id="postsContainer" class="post-list" style="margin-top: 12px;"></div>
        </div>

        <div id="editorView" class="card hidden">
            <div class="row">
                <div class="field">
                    <label>Title</label>
                    <input type="text" id="postTitle" placeholder="Title">
                </div>
                <div class="field">
                    <label>Slug</label>
                    <input type="text" id="postSlug" placeholder="slug">
                </div>
                <div class="field">
                            <label>Status</label>
                            <select id="postStatus">
                                <option value="draft">Draft</option>
                                <option value="published">Published</option>
                            </select>
                        </div>
                        </div>

            <div class="row">
                <div class="field">
                    <label>Author</label>
                    <input type="text" id="postAuthor" placeholder="CloudFace AI Team">
                </div>
                <div class="field">
                            <label>Read Time (minutes)</label>
                    <input type="text" id="postReadTime" placeholder="5">
                        </div>
                <div class="field">
                            <label>Published Date</label>
                    <input type="text" id="postPublishedDate" placeholder="January 15, 2026">
                        </div>
                    </div>

            <div class="row">
                <div class="field">
                            <label>Meta Description</label>
                    <input type="text" id="postMetaDescription" placeholder="Short description">
                        </div>
                <div class="field">
                            <label>Meta Keywords</label>
                    <input type="text" id="postMetaKeywords" placeholder="comma,separated,keywords">
                        </div>
                <div class="field">
                    <label>Badge (e.g., üîí PRIVACY)</label>
                    <input type="text" id="postBadge" placeholder="üìù BLOG">
                        </div>
                <div class="field">
                    <label>Thumbnail Image URL</label>
                    <div class="inline-row">
                        <input type="text" id="postThumbnailImage" placeholder="https://...">
                        <button class="btn btn-secondary" type="button" onclick="triggerThumbnailUpload()">Upload</button>
                    </div>
                    </div>
                <div class="field">
                    <label>OG Image</label>
                    <input type="text" id="postOgImage" placeholder="https://...">
                </div>
                    </div>

            <div class="field">
                <label>Content</label>
                <div class="editor-toolbar">
                    <button class="btn btn-secondary" type="button" onclick="formatBlock('h2')">H2</button>
                    <button class="btn btn-secondary" type="button" onclick="formatBlock('h3')">H3</button>
                    <button class="btn btn-secondary" type="button" onclick="execCommand('bold')">Bold</button>
                    <button class="btn btn-secondary" type="button" onclick="execCommand('insertUnorderedList')">List</button>
                    <button class="btn btn-secondary" type="button" onclick="insertLink()">Link</button>
                    <button class="btn btn-secondary" type="button" onclick="insertImage()">Image</button>
                    <button class="btn btn-secondary" type="button" onclick="insertYouTube()">YouTube</button>
                    <button class="btn btn-secondary" type="button" onclick="insertEmbed()">Embed</button>
                </div>
                <div id="postContent" class="editor-area" contenteditable="true"></div>
                <small style="color: var(--muted); margin-top: 6px; display: inline-block;">
                    Tip: drag & drop images into the editor to upload.
                </small>
            </div>

            <div class="row">
                <button class="btn btn-secondary" onclick="savePost()">Save</button>
                <button class="btn btn-primary" onclick="publishPost()">Publish</button>
                <button class="btn btn-secondary" onclick="unpublishPost()">Unpublish</button>
                <button class="btn btn-danger" onclick="deletePost()">Delete</button>
            </div>
        </div>
    </div>

    <input type="file" id="imageUploadInput" accept="image/*" class="hidden">
    <input type="file" id="thumbnailUploadInput" accept="image/*" class="hidden">

    <script>
        let currentPostId = null;
        const params = new URLSearchParams(window.location.search);
        let authPassword = params.get('pwd') || params.get('password') || '';

        function withAuth(url) {
            if (!authPassword) return url;
            const separator = url.includes('?') ? '&' : '?';
            return `${url}${separator}pwd=${encodeURIComponent(authPassword)}`;
        }

        function apiFetch(url, options) {
            return fetch(withAuth(url), Object.assign({ credentials: 'same-origin' }, options || {}));
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => {
                container.removeChild(alert);
            }, 4000);
        }

        function setPassword() {
            const value = document.getElementById('passwordInput').value.trim();
            if (!value) {
                showAlert('Password required', 'error');
                return;
            }
            window.location.search = `?pwd=${encodeURIComponent(value)}`;
        }

        function showList() {
            document.getElementById('listView').classList.remove('hidden');
            document.getElementById('editorView').classList.add('hidden');
            loadPosts();
        }

        function showEditor() {
            document.getElementById('listView').classList.add('hidden');
            document.getElementById('editorView').classList.remove('hidden');
        }

        function newPost() {
            currentPostId = null;
            document.getElementById('postTitle').value = '';
            document.getElementById('postSlug').value = '';
            document.getElementById('postStatus').value = 'draft';
            document.getElementById('postAuthor').value = 'CloudFace AI Team';
            document.getElementById('postReadTime').value = '5';
            document.getElementById('postPublishedDate').value = '';
            document.getElementById('postMetaDescription').value = '';
            document.getElementById('postMetaKeywords').value = '';
            document.getElementById('postBadge').value = 'üìù BLOG';
            document.getElementById('postThumbnailImage').value = '';
            document.getElementById('postOgImage').value = 'https://cloudface-ai.com/static/Cloudface-ai-logo.png';
            document.getElementById('postContent').innerHTML = '';
            showEditor();
        }

        function collectPostData() {
            return {
                title: document.getElementById('postTitle').value.trim(),
                slug: document.getElementById('postSlug').value.trim(),
                content: getCleanContent(),
                status: document.getElementById('postStatus').value,
                author: document.getElementById('postAuthor').value.trim(),
                read_time: document.getElementById('postReadTime').value.trim(),
                published_date: document.getElementById('postPublishedDate').value.trim(),
                meta_description: document.getElementById('postMetaDescription').value.trim(),
                meta_keywords: document.getElementById('postMetaKeywords').value.trim(),
                badge: document.getElementById('postBadge').value.trim(),
                thumbnail_image: document.getElementById('postThumbnailImage').value.trim(),
                og_image: document.getElementById('postOgImage').value.trim()
            };
        }

        function loadPosts() {
            if (!authPassword) {
                showAlert('Password required to load posts', 'error');
                return;
            }
            apiFetch('/api/blog/posts')
                .then(res => res.json())
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to load posts');
                    }
                    renderPosts(data.posts || []);
                })
                .catch(err => {
                    showAlert(err.message, 'error');
                });
        }

        function renderPosts(posts) {
            const container = document.getElementById('postsContainer');
            container.innerHTML = '';
            if (!posts.length) {
                container.innerHTML = '<p style="color: var(--muted);">No posts yet.</p>';
                return;
            }
            posts.forEach(post => {
                const item = document.createElement('div');
                item.className = 'post-item';
                item.innerHTML = `
                    <div class="post-meta">
                        <strong>${post.title || 'Untitled'}</strong>
                        <small>${post.status || 'draft'} ‚Ä¢ ${post.published_date || post.created_at || ''}</small>
                        <small>${post.badge || 'üìù BLOG'}</small>
                        <small>${post.slug || ''}</small>
                    </div>
                    <div class="row">
                        <button class="btn btn-secondary" data-id="${post.id}">Edit</button>
                        <button class="btn btn-primary" data-publish="${post.id}">${post.status === 'published' ? 'Unpublish' : 'Publish'}</button>
                        <button class="btn btn-danger" data-delete="${post.id}">Delete</button>
                    </div>
                `;
                container.appendChild(item);
                item.querySelector('[data-id]').addEventListener('click', () => editPost(post.id));
                item.querySelector('[data-delete]').addEventListener('click', () => deletePostById(post.id));
                item.querySelector('[data-publish]').addEventListener('click', () => {
                    if (post.status === 'published') {
                        unpublishById(post.id);
                    } else {
                        publishById(post.id);
                    }
                });
            });
        }

        function editPost(postId) {
            apiFetch(`/api/blog/posts/${postId}`)
                .then(res => res.json())
                .then(data => {
                    if (!data.success) throw new Error(data.error || 'Failed to load post');
                    const post = data.post || {};
                    currentPostId = post.id;
                    document.getElementById('postTitle').value = post.title || '';
                    document.getElementById('postSlug').value = post.slug || '';
                    document.getElementById('postStatus').value = post.status || 'draft';
                    document.getElementById('postAuthor').value = post.author || 'CloudFace AI Team';
                    document.getElementById('postReadTime').value = post.read_time || '5';
                    document.getElementById('postPublishedDate').value = post.published_date || '';
                    document.getElementById('postMetaDescription').value = post.meta_description || '';
                    document.getElementById('postMetaKeywords').value = post.meta_keywords || '';
                    document.getElementById('postBadge').value = post.badge || 'üìù BLOG';
                    document.getElementById('postThumbnailImage').value = post.thumbnail_image || '';
                    document.getElementById('postOgImage').value = post.og_image || 'https://cloudface-ai.com/static/Cloudface-ai-logo.png';
                    document.getElementById('postContent').innerHTML = post.content || '';
                    showEditor();
                })
                .catch(err => showAlert(err.message, 'error'));
        }

        function savePost() {
            if (!authPassword) {
                showAlert('Password required', 'error');
                return Promise.reject(new Error('Password required'));
            }
            const data = collectPostData();
            if (!data.title) {
                showAlert('Title required', 'error');
                return Promise.reject(new Error('Title required'));
            }
            const url = currentPostId ? `/api/blog/posts/${currentPostId}` : '/api/blog/posts';
            const method = currentPostId ? 'PUT' : 'POST';
            return apiFetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
                .then(result => {
                    if (!result.success) {
                        throw new Error(result.error || 'Save failed');
                    }
                    currentPostId = result.post.id;
                    showAlert('Saved', 'success');
                    return result;
            })
            .catch(err => {
                    showAlert(err.message, 'error');
                    throw err;
            });
        }

        function publishPost() {
            const doPublish = () => publishById(currentPostId);
            if (!currentPostId) {
                savePost().then(doPublish).catch(() => {});
            } else {
                doPublish();
            }
        }

        function publishById(postId) {
            return apiFetch(`/api/blog/posts/${postId}/publish`, { method: 'POST' })
                .then(res => res.json())
                .then(result => {
                    if (!result.success) throw new Error(result.error || 'Publish failed');
                        document.getElementById('postStatus').value = 'published';
                    showAlert('Published', 'success');
                        loadPosts();
                })
                .catch(err => showAlert(err.message, 'error'));
        }

        function unpublishPost() {
            if (!currentPostId) {
                showAlert('No post selected', 'error');
                return;
            }
            unpublishById(currentPostId);
        }

        function unpublishById(postId) {
            return apiFetch(`/api/blog/posts/${postId}/unpublish`, { method: 'POST' })
                .then(res => res.json())
                .then(result => {
                    if (!result.success) throw new Error(result.error || 'Unpublish failed');
                    document.getElementById('postStatus').value = 'draft';
                    showAlert('Unpublished', 'success');
                    loadPosts();
                })
                .catch(err => showAlert(err.message, 'error'));
        }

        function deletePost() {
            if (!currentPostId) {
                showAlert('No post selected', 'error');
                return;
            }
            deletePostById(currentPostId);
        }

        function deletePostById(postId) {
            if (!confirm('Delete this post?')) return;
            apiFetch(`/api/blog/posts/${postId}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(result => {
                    if (!result.success) throw new Error(result.error || 'Delete failed');
                    showAlert('Deleted', 'success');
                    if (postId === currentPostId) {
                        newPost();
                    }
                    loadPosts();
                })
                .catch(err => showAlert(err.message, 'error'));
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (authPassword) {
                document.getElementById('passwordCard').classList.add('hidden');
                showList();
            }
        });

        function execCommand(command) {
            document.getElementById('postContent').focus();
            document.execCommand(command, false, null);
        }

        function formatBlock(tag) {
            document.getElementById('postContent').focus();
            document.execCommand('formatBlock', false, tag);
        }

        function insertLink() {
            const url = prompt('Enter URL');
            if (!url) return;
            document.getElementById('postContent').focus();
            document.execCommand('createLink', false, url);
        }

        function insertImage() {
            const url = prompt('Image URL (leave blank to upload)');
            if (url) {
                insertImageUrl(url);
                return;
            }
            triggerImageUpload();
        }

        function insertYouTube() {
            const url = prompt('YouTube URL');
            if (!url) return;
            const match = url.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{6,})/);
            if (!match) {
                showAlert('Invalid YouTube URL', 'error');
                return;
            }
            const videoId = match[1];
            const embed = `
                <div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;">
                    <iframe src="https://www.youtube.com/embed/${videoId}" style="position:absolute;top:0;left:0;width:100%;height:100%;" frameborder="0" allowfullscreen></iframe>
                </div>`;
            insertHtmlAtCursor(embed);
        }

        function insertEmbed() {
            const code = prompt('Paste embed HTML');
            if (!code) return;
            insertHtmlAtCursor(code);
        }

        function insertImageUrl(url) {
            insertHtmlAtCursor(`<img src="${url}" alt="" style="max-width:100%;height:auto;">`);
        }

        function insertHtmlAtCursor(html) {
            const editor = document.getElementById('postContent');
            editor.focus();
            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0) {
                editor.innerHTML += html;
                return;
            }
            const range = selection.getRangeAt(0);
            range.deleteContents();
            const fragment = range.createContextualFragment(html);
            const lastNode = fragment.lastChild;
            range.insertNode(fragment);
            if (lastNode) {
                range.setStartAfter(lastNode);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }

        function getCleanContent() {
            const editor = document.getElementById('postContent');
            const clone = editor.cloneNode(true);
            clone.querySelectorAll('.image-handle').forEach((handle) => handle.remove());
            clone.querySelectorAll('.image-wrapper').forEach((wrapper) => {
                const img = wrapper.querySelector('img');
                if (img) {
                    wrapper.replaceWith(img);
                } else {
                    wrapper.replaceWith(...wrapper.childNodes);
                }
            });
            return clone.innerHTML;
        }

        function triggerImageUpload() {
            document.getElementById('imageUploadInput').click();
        }

        function triggerThumbnailUpload() {
            document.getElementById('thumbnailUploadInput').click();
        }

        function uploadImageFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            return apiFetch('/api/blog/upload-image', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.error || 'Upload failed');
                    }
                    return data.url;
                });
        }

        document.getElementById('imageUploadInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            uploadImageFile(file)
                .then(url => insertImageUrl(url))
                .catch(err => showAlert(err.message, 'error'))
                .finally(() => { event.target.value = ''; });
        });

        document.getElementById('thumbnailUploadInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            uploadImageFile(file)
                .then(url => {
                    document.getElementById('postThumbnailImage').value = url;
                    showAlert('Thumbnail uploaded', 'success');
                })
                .catch(err => showAlert(err.message, 'error'))
                .finally(() => { event.target.value = ''; });
        });

        const editorArea = document.getElementById('postContent');
        editorArea.addEventListener('dragover', (event) => {
            event.preventDefault();
            editorArea.classList.add('drag-over');
        });
        editorArea.addEventListener('dragleave', () => {
            editorArea.classList.remove('drag-over');
        });
        editorArea.addEventListener('drop', (event) => {
            event.preventDefault();
            editorArea.classList.remove('drag-over');
            const file = event.dataTransfer.files[0];
            if (!file) return;
            uploadImageFile(file)
                .then(url => insertImageUrl(url))
                .catch(err => showAlert(err.message, 'error'));
        });
        editorArea.addEventListener('click', (event) => {
            if (event.target && event.target.tagName === 'IMG') {
                setActiveImage(event.target);
            }
        });

        function setActiveImage(img) {
            editorArea.querySelectorAll('.image-handle').forEach((handle) => handle.remove());
            let wrapper = img.closest('.image-wrapper');
            if (!wrapper) {
                wrapper = document.createElement('span');
                wrapper.className = 'image-wrapper';
                img.parentNode.insertBefore(wrapper, img);
                wrapper.appendChild(img);
            }
            const handle = document.createElement('span');
            handle.className = 'image-handle';
            wrapper.appendChild(handle);
            handle.addEventListener('mousedown', (event) => startResize(event, img));
        }

        function startResize(event, img) {
            event.preventDefault();
            const startX = event.clientX;
            const startWidth = img.getBoundingClientRect().width;

            function onMouseMove(e) {
                const delta = e.clientX - startX;
                const newWidth = Math.max(120, startWidth + delta);
                img.style.width = `${newWidth}px`;
                img.style.height = 'auto';
            }

            function onMouseUp() {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }
    </script>
</body>
</html>

